<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Pixel Bird Locked</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #70c5ce;
            --text-color: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.4);
        }

        .dark-mode {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }

        /* CRITICAL: This stops the scrolling and bouncing on iOS */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; position: fixed; 
            background-color: #111; 
        }

        * { 
            -webkit-touch-callout: none; 
            -webkit-user-select: none; 
            touch-action: none; /* Stops all default touch behavior like scrolling */
            box-sizing: border-box; 
        }

        body {
            display: flex; justify-content: center; align-items: center;
            font-family: 'Press Start 2P', cursive;
        }

        #game-container {
            position: relative;
            width: 320px; height: 520px; 
            background-color: var(--bg-color);
            border: 6px solid #000;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            margin: auto;
        }

        canvas { display: block; image-rendering: pixelated; width: 100%; height: 100%; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; background: var(--overlay-bg);
            color: var(--text-color); z-index: 10; text-align: center;
        }

        #gear-btn {
            position: absolute; top: 10px; right: 10px;
            z-index: 100; font-size: 24px; cursor: pointer;
            background: none; border: none; color: white;
            text-shadow: 2px 2px #000;
        }

        button {
            padding: 12px; margin: 8px;
            font-family: 'Press Start 2P', cursive; font-size: 10px;
            background: #e67e22; color: white; border: 4px solid #d35400;
            cursor: pointer;
            touch-action: auto; /* Allows buttons to be clickable */
        }

        .hidden { display: none !important; }
        #score-val {
            position: absolute; top: 40px; width: 100%; text-align: center;
            font-size: 30px; color: white; text-shadow: 3px 3px #000;
            pointer-events: none; z-index: 5;
        }
        .high-score-label { font-size: 10px; margin: 5px 0; color: #f1c40f; }
    </style>
</head>
<body>

<div id="game-container">
    <button id="gear-btn" onclick="toggleSettings()">⚙️</button>
    <div id="score-val" class="hidden">0</div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="main-menu" class="overlay">
        <h1 style="font-size: 18px;">PIXEL BIRD</h1>
        <p id="menu-best" class="high-score-label">BEST: 0</p>
        <button onclick="startGame()">START</button>
    </div>

    <div id="settings-panel" class="overlay hidden">
        <h2 style="font-size: 14px;">SETTINGS</h2>
        <button onclick="toggleEasyMode()" id="diffBtn">MODE: NORMAL</button>
        <button onclick="toggleMute()" id="muteBtn">SOUND: ON</button>
        <button onclick="toggleDarkMode()" id="themeBtn">THEME: LIGHT</button>
        <button onclick="toggleSettings()" style="background:#7f8c8d; border-color:#2c3e50;">CLOSE</button>
    </div>

    <div id="game-over" class="overlay hidden">
        <h2 style="color: #e74c3c; font-size: 16px;">CRASHED</h2>
        <p id="final-score">SCORE: 0</p>
        <p id="best-score" class="high-score-label">BEST: 0</p>
        <button onclick="resetGame()">RETRY</button>
        <button onclick="goHome()" style="background:#3498db; border-color:#2980b9;">HOME</button>
    </div>
</div>

<script>
    // PREVENT ALL SCROLLING
    document.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

    var canvas = document.getElementById('gameCanvas');
    var ctx = canvas.getContext('2d');
    var scoreEl = document.getElementById('score-val');
    
    canvas.width = 320; canvas.height = 520;

    var state = 'MENU';
    var score = 0;
    var highScore = localStorage.getItem('pbHighScore') || 0;
    var frames = 0;
    var muted = false;
    var darkMode = false;
    var easyMode = false;

    document.getElementById('menu-best').innerText = "BEST: " + highScore;

    var bird = {
        x: 50, y: 200, w: 34, h: 24,
        v: 0, gravity: 0.25, jump: 4.6,
        draw: function() {
            ctx.fillStyle = "#333"; ctx.fillRect(this.x - 2, this.y - 2, this.w + 4, this.h + 4);
            ctx.fillStyle = "#f1c40f"; ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.fillStyle = "white"; ctx.fillRect(this.x+20, this.y+4, 8, 8);
            ctx.fillStyle = "black"; ctx.fillRect(this.x+24, this.y+6, 3, 3);
            ctx.fillStyle = "#e67e22"; ctx.fillRect(this.x + 28, this.y + 11, 12, 8);
            ctx.strokeStyle = "#000"; ctx.lineWidth = 1; ctx.strokeRect(this.x + 28, this.y + 11, 12, 8);
        },
        update: function() {
            if(state !== 'PLAYING') return;
            this.v += this.gravity;
            this.y += this.v;
            if (this.y + this.h > canvas.height) endGame();
            if (this.y < 0) this.y = 0;
        }
    };

    var pipes = {
        list: [], width: 52, 
        update: function() {
            if(state !== 'PLAYING') return;
            var gap = easyMode ? 170 : 120; 
            if(frames % 90 === 0) {
                this.list.push({ x: canvas.width, y: Math.random() * (canvas.height - 250) + 50 });
            }
            for(var i = 0; i < this.list.length; i++) {
                var p = this.list[i];
                p.x -= 2;
                if(bird.x + bird.w > p.x && bird.x < p.x + this.width) {
                    if(bird.y < p.y || bird.y + bird.h > p.y + gap) endGame();
                }
                if(p.x + this.width === bird.x) {
                    score++; scoreEl.innerText = score; beep(600, 0.1);
                }
                if(p.x + this.width < 0) this.list.splice(i, 1);
            }
        },
        draw: function() {
            var gap = easyMode ? 170 : 120;
            ctx.fillStyle = "#2ecc71";
            for(var i = 0; i < this.list.length; i++) {
                var p = this.list[i];
                ctx.fillRect(p.x, 0, this.width, p.y);
                ctx.fillRect(p.x, p.y + gap, this.width, canvas.height);
                ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
                ctx.strokeRect(p.x, 0, this.width, p.y);
                ctx.strokeRect(p.x, p.y + gap, this.width, canvas.height);
            }
        }
    };

    function startGame() {
        state = 'PLAYING';
        document.getElementById('main-menu').classList.add('hidden');
        scoreEl.classList.remove('hidden');
    }

    function endGame() {
        state = 'GAMEOVER';
        if(score > highScore) {
            highScore = score; localStorage.setItem('pbHighScore', highScore);
        }
        document.getElementById('game-over').classList.remove('hidden');
        document.getElementById('final-score').innerText = "SCORE: " + score;
        document.getElementById('best-score').innerText = "BEST: " + highScore;
        document.getElementById('menu-best').innerText = "BEST: " + highScore;
        beep(150, 0.3);
    }

    function resetGame() {
        bird.y = 200; bird.v = 0; pipes.list = [];
        score = 0; frames = 0; scoreEl.innerText = 0;
        document.getElementById('game-over').classList.add('hidden');
        state = 'PLAYING';
    }

    function goHome() {
        document.getElementById('game-over').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        scoreEl.classList.add('hidden');
        bird.y = 200; bird.v = 0; pipes.list = [];
        score = 0; frames = 0; scoreEl.innerText = 0;
        state = 'MENU';
    }

    function toggleSettings() {
        document.getElementById('settings-panel').classList.toggle('hidden');
    }

    function toggleEasyMode() {
        easyMode = !easyMode;
        document.getElementById('diffBtn').innerText = easyMode ? "MODE: EASY" : "MODE: NORMAL";
    }

    function toggleMute() {
        muted = !muted;
        document.getElementById('muteBtn').innerText = muted ? "SOUND: OFF" : "SOUND: ON";
    }

    function toggleDarkMode() {
        darkMode = !darkMode;
        document.body.classList.toggle('dark-mode');
        document.getElementById('themeBtn').innerText = darkMode ? "THEME: DARK" : "THEME: LIGHT";
    }

    function handleInput(e) {
        if(state === 'PLAYING') {
            bird.v = -bird.jump;
            beep(400, 0.05);
        }
    }

    window.addEventListener('mousedown', handleInput);
    window.addEventListener('touchstart', function(e) { 
        if(e.target.tagName !== 'BUTTON') { 
            e.preventDefault(); 
            handleInput(); 
        }
    }, {passive: false});

    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioCtx = new AudioContext();
    function beep(freq, duration) {
        if(muted) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        var osc = audioCtx.createOscillator();
        var gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq; gain.gain.value = 0.05;
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pipes.update(); pipes.draw();
        bird.update(); bird.draw();
        frames++; requestAnimationFrame(loop);
    }
    loop();

    if ('serviceWorker' in navigator) {
        var swCode = "self.addEventListener('fetch', function(event) { event.respondWith(fetch(event.request).catch(function() { return caches.match(event.request); })); });";
        var blob = new Blob([swCode], {type: 'text/javascript'});
        var url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url);
    }
</script>
</body>
</html>
